# Add dependency status

For `readyz`, if a critical dependency is unavailable, the application isn't ready to accept requests.

-  The database is the only critical dependency because we must be able to write the request to it

For `healthz`, report connectivity status of all dependencies (database, queue)

-  Don't bother testing auth service because
   -  If it gets this far, auth is almost certainly working
   -  Caching authN/authZ data means we may accept requests from some callers but not others, even if the auth service is unavailable now

Dependencies may vary based on infrastructure choices, so pass dependency checks to the build function.

## Add database check to readyz, return 500 if database isn't available

Pass an array of `readyz` dependencies containing an object `{ depName: string, depCheckFunction: () => Promise<Result<boolean, Error>>}`.

Iterate the array and call the functions. If any returns an error respond 500.

**COMMIT: FEAT: add dependency check to readyz so it can return 500 if any readiness dependency is not responding**

But is that a good choice?

If API consumers, k8s, etc., call `readyz` often, it could be spamming the services it depends on. Can I hook into circuit breakers?

If I know which circuit breakers matter for `readyz`, I can call `isConnected()` and get a plain boolean. That seems like a better choice.

-  Make the check function a simple boolean
-  In the `server` module, use the circuit breaker `isConnected()` functions as the check functions

That looks better and avoids async calls, which could take a (relatively) long time to run with reasonable timeouts.

The result may be wrong if the dependent service is up but the circuit breaker doesn't know yet. I think that's acceptable because retries on critical service dependencies should be reasonably short.

I think service dependencies will usually have a circuit breaker in place. If one doesn't, it requires a way to find service status that resolves to a non-async (non-Promise) boolean. So an object with a service status and a function to return the status.

**COMMIT: REFACTOR: use circuit breaker status instead of async service checks**
