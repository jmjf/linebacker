# Get a Fastify server running

## Plan

-  Build a server for Fastify and accept HTTP calls
-  Use Postgres in a container for Prisma
   -  Need a Docker setup for this; use `docker-compose` and include adminer
-  See log output that shows linebacker is handling them correctly

## PostgreSQL container

-  Pulled docker setup from another project I have that uses Postgres and adminer
-  Added environment variables to env/dev.env
-  `sudo docker-compose -f docker-compose/dev.env up`
-  Confirm I can connect adminer to the pg instance

## Connect Prisma to Postgres

-  Upgraded Prisma to 4.x
   -  After reviewing upgrade guide, I shouldn't have any issues, but we'll see
-  Prisma requires an environment variable with the Postgres connection string
   -  Added to protected env file
-  Prisma wants the environment file in specific (unprotected) places, so add `**/*.env` to `.gitignore`
-  `npx prisma generate` to create the client
-  `npx prisma migrate dev --name init` to generate the initial migration
-  See the pg database now has the tables

## Ensure Prisma upgrade didn't break anything (tests still pass)

-  Tests use a mock Prisma instance, so in theory, may break if Prisma isn't happy (or maybe not, but we'll run them anyway)
-  All pass, so if anything is broken, it isn't obvious yet

**COMMIT: 7.1.1 - CHORE: set up Postgres; get Prisma talking to it; use Prisma to generate the db**

## Build a Fastify server

-  `fastifyApp.ts` gives me a `buildApp()` that needs to be used to launch a server
-  Write `fastifyServer.ts`
   -  Reference: https://www.fastify.io/docs/latest/Guides/Testing, https://www.fastify.io/docs/latest/Guides/Getting-Started
   -  I need to `await` a Prisma connection in the server startup, so change `tsconfig.json` to use ESNext to allow it
      -  Tests pass, so at a basic level this doesn't seem to have broken anything
-  Trying to run it, I need `"type": "module"` in `package.json`
-  After a lot of searching, reading SO, GH, etc., it looks like node and ts-node are kind of struggling with this
   -  GH comment that worked for me: https://github.com/TypeStrong/ts-node/issues/1062#issuecomment-1028139483
   -  Except `APP_ENV=dev node --experimental-specifier-resolution=node --loader ts-node/esm src/fastifyServer.ts` because I need APP_ENV
      -  Tried `ts-node --esm` which someone else on the GH thread suggested, but it `cannot find module .../src/fastifyApp` even though I'm looking at it right beside
      -  Tried without the `--experimental*`, but gets the same error as trying to run with `ts-node --esm`
      -  I'm also seeing issues with compiled output not wanting to run (problems importing modules that are visible in `./dist`)
   -  This seems to be an ssue that causes many people pain and needs to be better explained/resolved or simplified
-  Add `fastify:dev` script to `package.json`

I think a lot of this comes down to the transition from CJS to ESM modules and the current challenges that has.

So, let's fire up Insomnia and create a test request to send.

```json
{
	"apiVersion": "2022-05-22",
	"backupJobId": "993aca31-453c-4c6c-878a-82551e2310a1",
	"dataDate": "2022-05-30",
	"backupDataLocation": "data-location"
}
```

It's saying route not found

-  Route was named `backup-request` when my prefered pattern is `backup-requests` (plural)
-  Fixed in Fastify and Express versions
-  Now it responds as expected and I see a row in the database
-  Server output shows the BackupRequestCreated event was created, but I don't see evidence the check allowed use case ran
   -  Look into that tomorrow

**COMMIT: FEAT: build Fastify server that can accept requests and update the database**
