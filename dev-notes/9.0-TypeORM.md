# Build adapters to connect to the database with TypeORM

For reasons, I need to support TypeORM, so build repo adapters that use it.

## Plan

My Prisma adapters probably serve as a pattern for my TypeORM adapters. TypeORM's syntax will be a bit different, but should be similar.

Basic plan:

-  Set up MSSQL docker compose (for reasons)
-  Install TypeORM
-  Define data-source and entities for TypeORM
   -  Use Prisma as a reference
-  Write a Q&D test program to confirm TypeORM can connect and write data
-  Write `TypeormBackupRequestRepo`

## Setup notes

MS SQL

-  Added `docker-compose/dev-ms.yml`
-  Added env variables to `env/dev.env`
   -  MSSQL_SA_PASSWORD="pick_your_password"
   -  ACCEPT_EULA="Y"
-  Tried to use volumes, but had issues, so commented out
-  Got SQL Server running and used Adminer to create a database
-  Tried to setup a login and user, but couldn't grant permissions, so will use sa for now
-  Added env variables to use for TypeORM
   -  SQLSERVER_USER=sa
   -  SQLSERVER_PASSWORD=pick_your_password
   -  SQLSERVER_DB=linebacker
   -  SQLSERVER_SCHEMA=lb

TypeORM

-  Referring to an install in a clean directory to find what I really need
-  `npm install typeorm mssql reflect-metadata`
-  Add to `tsconfig.json`
   -  "emitDecoratorMetadata": true
   -  "experimentalDecorators": true
   -  "strictPropertyInitialization": false
-  Create `/src/typeorm`, `/src/typeorm/entity`, `/src/typeorm/migration`
-  Create `/src/typeorm/dataSource.ts`
-  Create `.../entity/BackupRequest.entity.ts`
-  `npx typeorm migration:create src/typeorm/migration/backupRequest`
-  Build `.../migration/BackupRequest.sql` to create the table because I don't want TypeORM controlling the database structure
   -  Schema doesn't seem to work as expected, so just use dbo
-  Write test program `src/toTest.ts`

Errors encountered

-  TypeScript wouldn't compile entity
   -  Add to `tsconfig.json` -> `"strictPropertyInitialization": false`
-  Self-signed certificate error
   -  Add option to `toDataSource` -> `encrypted: false`
   -  TypeORM won't pass through `trustServerCertificate: true`
-  Can't connected because user is ''
   -  Load environment before importing `toDataSource`
-  Columns aren't nullable (apparently NOT NULL is the default)
   -  Add explicit NULL to SQL
   -  Alter table to make columns nullable

It works.

**COMMIT: CHORE: Get TypeORM functioning with MSSQL so I can begin developing with it**

## SQL Server improvements

Data doesn't persist after stopping the containers, so some more digging led me to an answer. The SQL Server 2019 image starts as non-root, so can't create anything. I found several possible solutions, but opted to add `user: root` to the container startup so it runs as root (easy, adequate).

I also figured out the login/user thing.

-  `create login linebacker with password='choose_your_password'` -- Use this id & pw
-  `use linebacker` to be in the linebacker database.
-  `create user lbuser for login linebacker` to create lbuser attached to the linebacker login
-  `EXEC sp_addrolemember 'db_datawriter', 'lbuser'` and same with `db_datareader` to give permissions at the database level
   -  I'll create tables myself instead of using migrations; more work, but more real world

Added SQLSERVER_URL and SQLSERVER_PORT to env and used them in `toDataSource`. I want to find a better env solution, but that's not immediate focus.

**COMMIT: CHORE: SQL Server setup improvements**

## Next steps

-  Write `TypeormBackupRequestRepo`
-  Write `Backup` entity
-  Write `TypeormBackupRepo`
