# Get check request allowed use case working

## First steps
[x] Start request backup use case in `create-backup/use-cases/check-request-allowed`
[x] Create a DTO in the same place. 
[x] Create backup job aggregate.
[x] Create backup job adapter interface.
[x] Create backup job adapter factory (for tests).
[x] Write test for use case -- when executed, the result isRight() (write use case to fail).
[x] Confirm test fails.
[x] Change use case to return a right() and test passes.

What data do we need about the backup job?
* Backup Job Id
* Backup storage path name
* Backup provider code
* Days to keep or a code we can translate to that based on a table
We'll go with that for now and add to it later if needed.

**COMMIT: 3.1.4.1 - build use case and first test**

[] test: when backup request is already checked, succeeds with no changes to the request
[] test: when backup request is already sent to interface, succeeds with no changes to the request
[] test: when backup request is already replied, succeeds with no changes to the request
[] test: when backup request id is not found, fails with 'Backup request not found' message
[] test: when backup request is not in received status, fails with 'not in received status' message
[] test: when backup job is not found, fails with 'Backup job not found' message

Need to think about how to induce "not received" case. Not sure I can force an invalid state without trickery.

**COMMIT: 3.1.4.2 - build remaining test cases**

How will this use case set up an event to cause sent to interface to run?

## Planning and testing notes
This use case needs a backupRequest. It is separate from the create request use case because we need to handle allowed checks differently for HTTP vs. queue transports. Also, the startup recovery process will look for any requested but not checked backup requests and check them.

The plan is:
* HTTP controller will call the use case directly and wait for a response so it can reply with a 400 if not allowed. Timeout = 408.
* Queue controller will call the use case directly but doesn't care about the response. (May do an await-less call?)
* Startup recovery will get backup request, add the domain event for the use case and trigger event processing. (Need to think about how this works. May make more sense for queue to do this too.)
* Use case will update the backup request's status, checked timestamp, and other data it gets that the backup request needs filled in. If allowed, it will trigger an event that runs the send to interface use case.

I don't need an actual repo yet because the use case will always get data from the main create backup controller, which gets it from the create request use case or from a startup recovery process that has a list of backup requests from the repo.

While this is the second step in the process, I'm writing it third because it depends on the send to interface use case.